{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { readFileSync } from 'fs'\nimport { resolve } from 'path'\nimport type { Plugin, ResolvedConfig } from 'vite'\nimport type { Options } from '@plugin-web-update-notification/core'\n\nimport {\n  DIRECTORY_NAME,\n  INJECT_SCRIPT_FILE_NAME,\n  INJECT_STYLE_FILE_NAME,\n  JSON_FILE_NAME,\n  NOTIFICATION_ANCHOR_CLASS_NAME,\n  generateJSONFileContent,\n  generateJsFileContent,\n  getFileHash,\n  getVersion,\n  get__Dirname,\n} from '@plugin-web-update-notification/core'\n\n/**\n * Get the version of the current Vite\n *\n * if the viteVersion is undefined, we assume that vite is less than v3.0（after v3.0, vite export version）\n */\nasync function getViteVersion(): Promise<string | undefined> {\n  return await import('vite').then(({ version }) => version)\n}\n\n/**\n * It injects the hash into the HTML, and injects the notification anchor and the stylesheet and the\n * script into the HTML\n * @param {string} html - The original HTML of the page\n * @param {string} version - The hash of the current commit\n * @param {Options} options - Options\n * @returns The html of the page with the injected script and css.\n */\nfunction injectPluginHtml(\n  html: string,\n  version: string,\n  options: Options,\n  { cssFileHash, jsFileHash }: { jsFileHash: string; cssFileHash: string },\n) {\n  const { customNotificationHTML, hiddenDefaultNotification, injectFileBase = '' } = options\n\n  const versionScript = `<script>window.pluginWebUpdateNotice_version = '${version}';</script>`\n  const cssLinkHtml = customNotificationHTML || hiddenDefaultNotification ? '' : `<link rel=\"stylesheet\" href=\"${injectFileBase}${DIRECTORY_NAME}/${INJECT_STYLE_FILE_NAME}.${cssFileHash}.css\">`\n  let res = html\n\n  res = res.replace(\n    '<head>',\n    `<head>\n    ${cssLinkHtml}\n    <script src=\"${injectFileBase}${DIRECTORY_NAME}/${INJECT_SCRIPT_FILE_NAME}.${jsFileHash}.js\"></script>\n    ${versionScript}`,\n  )\n\n  if (!hiddenDefaultNotification) {\n    res = res.replace(\n      '</body>',\n      `<div class=\"${NOTIFICATION_ANCHOR_CLASS_NAME}\"></div></body>`,\n    )\n  }\n\n  return res\n}\n\nexport function webUpdateNotice(options: Options = {}): Plugin {\n  let viteConfig: ResolvedConfig\n  let viteVersion: string | undefined\n\n  const { versionType, customVersion, silence } = options\n  let version = ''\n  if (versionType === 'custom')\n    version = getVersion(versionType, customVersion!)\n  else\n    version = getVersion(versionType!)\n\n  /** inject script file hash */\n  let jsFileHash = ''\n  /** inject css file hash */\n  let cssFileHash = ''\n\n  const cssFileSource = readFileSync(`${resolve(get__Dirname(), INJECT_STYLE_FILE_NAME)}.css`, 'utf8').toString()\n  cssFileHash = getFileHash(cssFileSource)\n\n  let jsFileSource = ''\n\n  return {\n    name: 'vue-vite-web-update-notice',\n    apply: 'build',\n    enforce: 'post',\n    async configResolved(resolvedConfig: ResolvedConfig) {\n      // 存储最终解析的配置\n      viteConfig = resolvedConfig\n      if (options.injectFileBase === undefined)\n        options.injectFileBase = viteConfig.base\n\n      jsFileSource = generateJsFileContent(\n        readFileSync(`${resolve(get__Dirname(), INJECT_SCRIPT_FILE_NAME)}.js`, 'utf8').toString(),\n        version,\n        options,\n      )\n      jsFileHash = getFileHash(jsFileSource)\n\n      viteVersion = await getViteVersion()\n    },\n    generateBundle(_, bundle = {}) {\n      if (!version)\n        return\n      // inject version json file\n      bundle[JSON_FILE_NAME] = {\n        // @ts-expect-error: for Vite 3 support, Vite 4 has removed `isAsset` property\n        isAsset: true,\n        type: 'asset',\n        name: undefined,\n        source: generateJSONFileContent(version, silence),\n        fileName: `${DIRECTORY_NAME}/${JSON_FILE_NAME}.json`,\n      }\n\n      // inject css file\n      bundle[INJECT_STYLE_FILE_NAME] = {\n        // @ts-expect-error: for Vite 3 support, Vite 4 has removed `isAsset` property\n        isAsset: true,\n        type: 'asset',\n        name: undefined,\n        source: cssFileSource,\n        fileName: `${DIRECTORY_NAME}/${INJECT_STYLE_FILE_NAME}.${cssFileHash}.css`,\n      }\n\n      // inject js file\n      bundle[INJECT_SCRIPT_FILE_NAME] = {\n        // @ts-expect-error: for Vite 3 support, Vite 4 has removed `isAsset` property\n        isAsset: true,\n        type: 'asset',\n        name: undefined,\n        source: jsFileSource,\n        fileName: `${DIRECTORY_NAME}/${INJECT_SCRIPT_FILE_NAME}.${jsFileHash}.js`,\n      }\n    },\n    transformIndexHtml:\n      // if the viteVersion is undefined, we assume that vite is less than v3.0（after v3.0, vite export version）\n      viteVersion === undefined\n        ? {\n            enforce: 'post',\n            async transform(html: string) {\n              if (version)\n                return injectPluginHtml(html, version, options, { jsFileHash, cssFileHash })\n\n              return html\n            },\n          }\n        : {\n            order: 'post',\n            handler(html: string, { chunk }) {\n              if (version && chunk)\n                return injectPluginHtml(html, version, options, { jsFileHash, cssFileHash })\n              return html\n            },\n          },\n  }\n}\n"],"mappings":"AAAA,OAAS,gBAAAA,MAAoB,KAC7B,OAAS,WAAAC,MAAe,OAIxB,OACE,kBAAAC,EACA,2BAAAC,EACA,0BAAAC,EACA,kBAAAC,EACA,kCAAAC,EACA,2BAAAC,EACA,yBAAAC,EACA,eAAAC,EACA,cAAAC,EACA,gBAAAC,MACK,uCAOP,eAAeC,GAA8C,CAC3D,OAAO,KAAM,QAAO,MAAM,EAAE,KAAK,CAAC,CAAE,QAAAC,CAAQ,IAAMA,CAAO,CAC3D,CAUA,SAASC,EACPC,EACAF,EACAG,EACA,CAAE,YAAAC,EAAa,WAAAC,CAAW,EAC1B,CACA,GAAM,CAAE,uBAAAC,EAAwB,0BAAAC,EAA2B,eAAAC,EAAiB,EAAG,EAAIL,EAE7EM,EAAgB,mDAAmDT,eACnEU,EAAcJ,GAA0BC,EAA4B,GAAK,gCAAgCC,IAAiBnB,KAAkBE,KAA0Ba,UACxKO,EAAMT,EAEV,OAAAS,EAAMA,EAAI,QACR,SACA;AAAA,MACED;AAAA,mBACaF,IAAiBnB,KAAkBC,KAA2Be;AAAA,MAC3EI,GACJ,EAEKF,IACHI,EAAMA,EAAI,QACR,UACA,eAAelB,kBACjB,GAGKkB,CACT,CAEO,SAASC,EAAgBT,EAAmB,CAAC,EAAW,CAC7D,IAAIU,EACAC,EAEE,CAAE,YAAAC,EAAa,cAAAC,EAAe,QAAAC,CAAQ,EAAId,EAC5CH,EAAU,GACVe,IAAgB,SAClBf,EAAUH,EAAWkB,EAAaC,CAAc,EAEhDhB,EAAUH,EAAWkB,CAAY,EAGnC,IAAIV,EAAa,GAEbD,EAAc,GAEZc,EAAgB/B,EAAa,GAAGC,EAAQU,EAAa,EAAGP,CAAsB,QAAS,MAAM,EAAE,SAAS,EAC9Ga,EAAcR,EAAYsB,CAAa,EAEvC,IAAIC,EAAe,GAEnB,MAAO,CACL,KAAM,6BACN,MAAO,QACP,QAAS,OACT,MAAM,eAAeC,EAAgC,CAEnDP,EAAaO,EACTjB,EAAQ,iBAAmB,SAC7BA,EAAQ,eAAiBU,EAAW,MAEtCM,EAAexB,EACbR,EAAa,GAAGC,EAAQU,EAAa,EAAGR,CAAuB,OAAQ,MAAM,EAAE,SAAS,EACxFU,EACAG,CACF,EACAE,EAAaT,EAAYuB,CAAY,EAErCL,EAAc,MAAMf,EAAe,CACrC,EACA,eAAesB,EAAGC,EAAS,CAAC,EAAG,CACxBtB,IAGLsB,EAAO9B,CAAc,EAAI,CAEvB,QAAS,GACT,KAAM,QACN,KAAM,OACN,OAAQE,EAAwBM,EAASiB,CAAO,EAChD,SAAU,GAAG5B,KAAkBG,QACjC,EAGA8B,EAAO/B,CAAsB,EAAI,CAE/B,QAAS,GACT,KAAM,QACN,KAAM,OACN,OAAQ2B,EACR,SAAU,GAAG7B,KAAkBE,KAA0Ba,OAC3D,EAGAkB,EAAOhC,CAAuB,EAAI,CAEhC,QAAS,GACT,KAAM,QACN,KAAM,OACN,OAAQ6B,EACR,SAAU,GAAG9B,KAAkBC,KAA2Be,MAC5D,EACF,EACA,mBAEES,IAAgB,OACZ,CACE,QAAS,OACT,MAAM,UAAUZ,EAAc,CAC5B,OAAIF,EACKC,EAAiBC,EAAMF,EAASG,EAAS,CAAE,WAAAE,EAAY,YAAAD,CAAY,CAAC,EAEtEF,CACT,CACF,EACA,CACE,MAAO,OACP,QAAQA,EAAc,CAAE,MAAAqB,CAAM,EAAG,CAC/B,OAAIvB,GAAWuB,EACNtB,EAAiBC,EAAMF,EAASG,EAAS,CAAE,WAAAE,EAAY,YAAAD,CAAY,CAAC,EACtEF,CACT,CACF,CACR,CACF","names":["readFileSync","resolve","DIRECTORY_NAME","INJECT_SCRIPT_FILE_NAME","INJECT_STYLE_FILE_NAME","JSON_FILE_NAME","NOTIFICATION_ANCHOR_CLASS_NAME","generateJSONFileContent","generateJsFileContent","getFileHash","getVersion","get__Dirname","getViteVersion","version","injectPluginHtml","html","options","cssFileHash","jsFileHash","customNotificationHTML","hiddenDefaultNotification","injectFileBase","versionScript","cssLinkHtml","res","webUpdateNotice","viteConfig","viteVersion","versionType","customVersion","silence","cssFileSource","jsFileSource","resolvedConfig","_","bundle","chunk"]}